<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>/bo/ - Board | #1</title>

    <link rel="stylesheet" href="../../static/css/midnight.css">
    <!--<link rel="stylesheet" href="../static/css/custom/midday.css">-->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

</head>

<body>
    <div class="container">
        <header>
            <a href="index_example.html"><img class="header-logo" src="var(--lo-img)" alt="Tupibooru"></a>
            <nav class="navbar">
                <ul>
                    <li><a href="board_example.html">/bo/ - Boteco</a></li>
                    <li><a href="board_example.html">/an/ - Animang√°</a></li>
                    <li><a href="board_example.html">/tv/ - Filmes e S√©ries</a></li>
                    <li><a href="board_example.html">/cri/ - Cria√ß√µes</a></li>
                    <li><a href="board_example.html">/pc/ - Computarias</a></li>
                    <li><a href="board_example.html">/flb/ - Faria Lima Bets</a></li>

                    <li tabindex="0" style="display: none;">
                        <a>Outros</a>
                        <ul class="others-dropdown">
                            <li><a href="board_example.html">/bo/ - Boteco</a></li>
                            <li><a href="board_example.html">/an/ - Animang√°</a></li>
                            <li><a href="board_example.html">/tv/ - Filmes e S√©ries</a></li>
                            <li><a href="board_example.html">/cri/ - Cria√ß√µes</a></li>
                        </ul>
                    </li>
                    <li tabindex="0">
                        <a>Conta</a>
                        <div class="login-dropdown">
                            <p>Login</p>
                            <form action="">
                                <div>
                                    <span class="material-symbols-outlined">
                                        mail
                                    </span>
                                    <input type="text" placeholder="Usu√°rio ou Email">
                                </div>
                                <div>
                                    <span class="material-symbols-outlined">
                                        key
                                    </span>
                                    <input type="password" placeholder="Senha">
                                </div>
                                <button type="submit">Logar-se<span class="material-symbols-outlined">
                                        login
                                    </span></button>
                            </form>
                            <div><a href="">Esqueceu a senha?</a>‚Ä¢<a href="register_example.html">Crie uma conta</a>
                            </div>
                        </div>
                    </li>
                </ul>
            </nav>
        </header>
        <main class="thread-main">
            <article>
                <section class="post-bar">
                    <section class="post-profile">
                        <a href="">
                            <div class="post-userphoto" style="display: none;" alt=""></div><span
                                class="material-symbols-outlined">
                                no_accounts
                            </span>
                            <p class="post-username">‚Ä¢ An√¥nimo</p>
                        </a>
                    </section>
                    <section class="post-title">
                        <a>T√≠tulo do Post</a>
                    </section>
                    <section class="post-buttons">
                        <button class="default-button moderate">
                            <span class="material-symbols-outlined">
                                policy
                            </span>
                        </button>
                        <button class="default-button delete" onclick="openModal()">
                            <span class="material-symbols-outlined">
                                delete
                            </span>
                        </button>
                        <button class="default-button return" onclick="window.history.go(-1); return false;">
                            <span class="material-symbols-outlined">
                                keyboard_return
                            </span>
                        </button>
                    </section>
                </section>

                <section class="post-content">
                    <section class="post-media">
                        <div class="media-wrapper">
                            <img loading="lazy" src="../../static/imgs/decoration/expost1.png" alt="">
                        </div>
                    </section>
                    <section class="post-text">
                        <pre>Este √© um post de exemplo.
Possui um √∫nico anexo.</pre>
                    </section>
                </section>

                <section class="post-bar">
                    <section class="post-engage">
                        <button class="default-button bump">
                            <span class="material-symbols-outlined">
                                thumb_up
                            </span>Bump
                        </button>
                        <button class="default-button sage">
                            <span class="material-symbols-outlined">
                                thumb_down
                            </span>Sage
                        </button>
                    </section>
                    <section class="post-date">
                        <a>Data do Post</a>
                    </section>
                    <section class="post-buttons">
                        <button class="default-button post">
                            <span class="material-symbols-outlined">
                                chat
                            </span>1
                        </button>
                        <button class="default-button block">
                            <span class="material-symbols-outlined">
                                visibility_off
                            </span>
                        </button>
                        <button class="default-button report">
                            <span class="material-symbols-outlined">
                                warning
                            </span>
                        </button>
                    </section>
                </section>
            </article>
            <article>
                <section class="reply-bar">
                    <a class="reply-profile" href="">
                        <div class="post-userphoto" alt=""></div>
                        <p class="post-username">‚Ä¢ Mymy</p>
                    </a>
                    <section class="post-date">
                        ‚Ä¢ <a>Data do Post</a>
                    </section>
                    <section class="post-buttons">
                        <button class="default-button moderate">
                            <span class="material-symbols-outlined">
                                policy
                            </span>
                        </button>
                        <button class="default-button delete">
                            <span class="material-symbols-outlined">
                                delete
                            </span>
                        </button>
                        <button class="default-button block">
                            <span class="material-symbols-outlined">
                                visibility_off
                            </span>
                        </button>
                        <button class="default-button report">
                            <span class="material-symbols-outlined">
                                warning
                            </span>
                        </button>
                        <button class="default-button post">
                            <span class="material-symbols-outlined">
                                reply
                            </span>
                        </button>
                    </section>
                </section>
                <section class="post-content">
                    <section class="post-text">
                        <pre>Isso √© uma resposta de usu√°rio, sem anexos.</pre>
                    </section>
                </section>
            </article>
        </main>
        <footer>
            <section>
                <div class="footer-socials">
                    <a href=""><img class="footer-logo" src="var(--lo-img)" alt="Tupibooru"></a>
                    <div></div>
                </div>
                <div class="footer-copyright">
                    <p>Baseado na engine do&nbsp;<a href="https://github.com/lainsec/rchan" target="_blank">rchan.</a>
                    </p>
                    <p>¬© 2025 Rede Autumn.</p>
                </div>
            </section>
            <section>

            </section>
        </footer>
    </div>

    <dialog class="popup-delete">
        <form action="">
            <div class="popup-title">Excluir Post</div>
            <div class="popup-context">Deseja mesmo excluir este post?<br>Esta a√ß√£o √© irrevers√≠vel.</div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">Excluir</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-block">
        <form action="">
            <div class="popup-title">Bloquear Usu√°rio</div>
            <div class="popup-context">Deseja bloquear este usu√°rio?<br>Voc√™ n√£o ver√° mais posts dele(a).</div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">Bloquear</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-report">
        <form action="">
            <div class="popup-title">Denunciar Post</div>
            <div class="popup-context">
                <textarea name="Report" placeholder="Motivo da den√∫ncia . . ." rows="5" maxlength="255"></textarea>
            </div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">Denunciar</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-moderate">
        <div>
            <div class="popup-title">Moderar Post</div>
            <div class="popup-context">
                <article>
                    <section class="post-content">
                        <section class="post-media">
                            <div class="media-wrapper">
                                <img loading="lazy" src="../../static/imgs/decoration/expost1.png" alt="">
                            </div>
                        </section>
                        <section class="post-text">
                            <pre>Este √© um post de exemplo.Possui um √∫nico anexo.</pre>
                        </section>
                    </section>
                </article>
            </div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button lock" onclick="openModal()">Trancar</button>
                <button class="default-button pin" onclick="openModal()">Fixar</button>
                <button class="default-button warn" onclick="openModal()">Advertir</button>
                <button class="default-button ban" onclick="openModal()">Banir</button>
            </div>
        </div>
    </dialog>
    <dialog class="popup-lock">
        <form action="">
            <div class="popup-title">Trancar Post</div>
            <div class="popup-context">Deseja trancar este post?<br>Outros usu√°rios n√£o poder√£o mais respond√™-lo.</div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">Trancar</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-pin">
        <form action="">
            <div class="popup-title">Fixar Post</div>
            <div class="popup-context">Deseja fixar este post a p√°gina inicial?</div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">Fixar</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-warn">
        <form action="">
            <div class="popup-title">Advertir Post</div>
            <select name="warn-type" id="warn-type">
                <option value="0">
                    <p>Sem advert√™ncia de perfil</p>
                </option>
                <option value="1">
                    <p>Quebra de regras de board/global</p>
                </option>
                <option value="2">
                    <p>Conte√∫do NSFW expl√≠cito</p>
                </option>
                <option value="3">
                    <p>Polui√ß√£o de board/thread</p>
                </option>
                <option value="4">
                    <p>Inclus√£o digital</p>
                </option>
            </select>
            <div class="popup-context">
                <textarea name="warn" placeholder="Mensagem de advert√™ncia . . ." rows="3" maxlength="255"></textarea>
            </div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">Advertir</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-ban">
        <form action="">
            <div class="popup-title">Banir Usu√°rio</div>
            <div class="popup-context">Deseja banir este usu√°rio? Selecione uma dura√ß√£o.
                <select name="ban-type" id="ban-type">
                    <option value="local">
                        <p>Banir usu√°rio apenas nesta board</p>
                    </option>
                    <option value="global">
                        <p>Banir usu√°rio globalmente</p>
                    </option>
                </select>
                <div class="delban">
                    <input type="checkbox" id="delban">
                    <label for="delban">Excluir o hist√≥rico de posts deste usu√°rio</label>
                </div>
            </div>
            <div class="popup-buttons">
                <button class="underline-button cancel" type="button"
                    onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="default-button submit">1d</button>
                <button class="default-button submit">3d</button>
                <button class="default-button submit">7d</button>
                <button class="default-button submit">1m</button>
                <button class="default-button submit">3m</button>
                <button class="default-button submit">Perma.</button>
            </div>
        </form>
    </dialog>
    <dialog class="popup-post">
        <form action="">
            <div class="popup-title">Criar Post</div>
            <div class="popup-context">
                <textarea name="Title" placeholder="T√≠tulo (Opcional)" rows="1" maxlength="255"></textarea>
            </div>
            <div class="popup-context">
                <textarea name="Text" placeholder="Inserir mensagem . . ." rows="5" maxlength="255"></textarea>
            </div>
            <div class="popup-context">
                <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
                    style="display: none;">
                <button type="button" class="select-file-button"
                    onclick="document.getElementById('fileInput').click()">Selecione um arquivo</button>
                <div class="file-previews-container">
                </div>
                <div class="popup-buttons">
                    <button class="underline-button cancel" type="button"
                        onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                    <button class="default-button create">Publicar</button>
                </div>
        </form>
    </dialog>
</body>

<script>
    // Sidebar
    document.addEventListener('DOMContentLoaded', (event) => {
        const minimizeButtons = document.querySelectorAll('.side-title .minimize');

        minimizeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const sideTitleDiv = button.parentElement;

                let sideContentDiv = sideTitleDiv.nextElementSibling;
                while (sideContentDiv && !sideContentDiv.classList.contains('side-content')) {
                    sideContentDiv = sideContentDiv.nextElementSibling;
                }

                if (sideContentDiv) {
                    sideContentDiv.classList.toggle('collapsed');

                    button.classList.toggle('collapsed');
                }
            });
        });
    });

    //Board Posts
    document.addEventListener('DOMContentLoaded', () => {
        const minimizeButtons = document.querySelectorAll('.minimize');

        minimizeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const article = button.closest('article');
                if (!article) return;

                const parentPostBar = button.closest('.post-bar');
                if (!parentPostBar) return;

                let nextElement = parentPostBar.nextElementSibling;
                while (nextElement) {
                    if (nextElement.tagName === 'SECTION') {
                        if (nextElement.style.display === 'none') {
                            nextElement.style.display = '';
                        } else {
                            nextElement.style.display = 'none';
                        }
                    }
                    nextElement = nextElement.nextElementSibling;
                }

                const icon = button.querySelector('.material-symbols-outlined');
                if (icon) {
                    icon.classList.toggle('rotated');
                }
            });
        });
    });

    // Revelar/Ocultar Popups
    function closeModal(dialogElement) {
        if (dialogElement && dialogElement.close) {
            dialogElement.close();
        }
    }

    const triggerClasses = ['delete', 'pin', 'lock', 'warn', 'ban', 'block', 'report', 'moderate', 'post'];

    document.addEventListener('click', function (event) {
        const triggerSelector = triggerClasses.map(cls => '.' + cls).join(', ');

        const clickedTrigger = event.target.closest(triggerSelector);

        if (clickedTrigger) {
            event.preventDefault();

            let dialogClass = null;
            for (const cls of triggerClasses) {
                if (clickedTrigger.classList.contains(cls)) {
                    dialogClass = 'popup-' + cls;
                    break;
                }
            }

            if (dialogClass) {
                const dialog = document.querySelector('.' + dialogClass);

                if (dialog) {
                    dialog.showModal();
                } else {
                    console.error('Erro: Dialog com a classe "' + dialogClass + '" n√£o encontrada.');
                }
            }
        }
    });

    // Criar Posts
    const fileInput = document.getElementById('fileInput');
    const filePreviewsContainer = document.querySelector('.file-previews-container');
    let selectedFiles = [];

    function createFilePreviewElement(file, index) {
        const previewItem = document.createElement('div');
        previewItem.classList.add('file-preview-item');
        previewItem.dataset.originalIndex = index;

        const thumbnailDiv = document.createElement('div');
        thumbnailDiv.classList.add('file-preview-thumbnail');


        const fileNameSpan = document.createElement('span');
        fileNameSpan.classList.add('file-preview-name');
        fileNameSpan.textContent = file.name;

        const removeButton = document.createElement('button');
        removeButton.classList.add('remove-file-button');
        const closeIconSpan = document.createElement('span');
        closeIconSpan.classList.add('material-symbols-outlined');
        closeIconSpan.textContent = 'close';
        removeButton.appendChild(closeIconSpan);
        removeButton.type = 'button';

        removeButton.onclick = () => {
            const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
            removeFilePreview(itemIndex);
        };

        previewItem.appendChild(thumbnailDiv);
        previewItem.appendChild(fileNameSpan);
        previewItem.appendChild(removeButton);

        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            const reader = new FileReader();

            reader.onload = (e) => {
                img.src = e.target.result;
                thumbnailDiv.appendChild(img);
            };

            reader.onerror = (e) => {
                console.error('Erro ao ler arquivo de imagem:', file.name, e);
                const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
                removeFilePreview(itemIndex);
            };

            reader.readAsDataURL(file);

        } else if (file.type.startsWith('video/')) {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let videoObjectURL = null;

            video.autoplay = false;
            video.muted = true;
            video.playsInline = true;

            video.addEventListener('loadeddata', () => {
                const thumbnailSize = 40;
                canvas.width = thumbnailSize;
                canvas.height = thumbnailSize;

                video.currentTime = 0.1;
            });

            video.addEventListener('seeked', () => {
                try {

                    const videoRatio = video.videoWidth / video.videoHeight;
                    const thumbnailRatio = canvas.width / canvas.height;
                    let sx, sy, sWidth, sHeight;

                    if (videoRatio > thumbnailRatio) {
                        sHeight = video.videoHeight;
                        sWidth = sHeight * thumbnailRatio;
                        sx = (video.videoWidth - sWidth) / 2;
                        sy = 0;
                    } else {
                        sWidth = video.videoWidth;
                        sHeight = sWidth / thumbnailRatio;
                        sx = 0;
                        sy = (video.videoHeight - sHeight) / 2;
                    }

                    context.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/jpeg');

                    thumbnailDiv.appendChild(img);

                    if (videoObjectURL) URL.revokeObjectURL(videoObjectURL);

                } catch (e) {
                    console.error('Erro ao gerar thumbnail do v√≠deo:', file.name, e);
                    const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
                    removeFilePreview(itemIndex);
                    if (videoObjectURL) URL.revokeObjectURL(videoObjectURL);
                }

            }, { once: true });

            video.addEventListener('error', (e) => {
                console.error('Erro ao carregar v√≠deo para thumbnail:', file.name, e);
                const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
                removeFilePreview(itemIndex);
                const errorIcon = document.createElement('span');
                errorIcon.textContent = '‚ùå';
                errorIcon.style.fontSize = '1.5rem';
                thumbnailDiv.appendChild(errorIcon);

                if (videoObjectURL) URL.revokeObjectURL(videoObjectURL);
            });

            videoObjectURL = URL.createObjectURL(file);
            video.src = videoObjectURL;

        } else {
            const fileIcon = document.createElement('span');
            fileIcon.textContent = 'üìÑ';
            fileIcon.style.fontSize = '1.5rem';
            thumbnailDiv.appendChild(fileIcon);
        }

        return previewItem;
    }

    function removeFilePreview(index) {
        console.log('Removendo arquivo no √≠ndice:', index);
        const itemToRemove = filePreviewsContainer.querySelector(`.file-preview-item[data-original-index="${index}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }

        if (index >= 0 && index < selectedFiles.length) {
            selectedFiles[index] = null;
        } else {
            console.warn('Tentativa de remover √≠ndice inv√°lido:', index);
        }

        const currentFileCount = selectedFiles.filter(file => file !== null).length;
        console.log('Contagem atual de arquivos:', currentFileCount);
        if (currentFileCount < 3) {
            document.querySelector('.select-file-button').disabled = false;
        }
    }

    function addFiles(files) {
        const selectButton = document.querySelector('.select-file-button');
        const currentFileCount = selectedFiles.filter(file => file !== null).length;
        const filesToAdd = Array.from(files).slice(0, 3 - currentFileCount);

        if (filesToAdd.length === 0) {
            if (currentFileCount >= 3) {
                selectButton.disabled = true;
            }
            return;
        }

        filesToAdd.forEach(file => {
            let nextIndex = selectedFiles.indexOf(null);
            if (nextIndex === -1) {
                nextIndex = selectedFiles.length;
                selectedFiles.push(file);
            } else {
                selectedFiles[nextIndex] = file;
            }

            const previewElement = createFilePreviewElement(file, nextIndex);

            setTimeout(() => {
                filePreviewsContainer.appendChild(previewElement);
                const updatedFileCount = selectedFiles.filter(f => f !== null).length;
                if (updatedFileCount >= 3) {
                    selectButton.disabled = true;
                }

            }, 0);

        });

        console.log("Scheduled addition for:", filesToAdd.map(f => f ? f.name : null));
        console.log("selectedFiles total (n√£o-null) ap√≥s agendar adi√ß√£o:", selectedFiles.filter(f => f !== null).length);
    }

    function removeFilePreview(index) {
        console.log('Removendo arquivo no √≠ndice:', index);
        const itemToRemove = filePreviewsContainer.querySelector(`.file-preview-item[data-original-index="${index}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }

        if (index >= 0 && index < selectedFiles.length) {
            selectedFiles[index] = null;
        } else {
            console.warn('Tentativa de remover √≠ndice inv√°lido:', index);
        }

        const selectButton = document.querySelector('.select-file-button');
        const currentFileCount = selectedFiles.filter(file => file !== null).length;
        if (currentFileCount < 3) {
            selectButton.disabled = false;
        }

        console.log("selectedFiles ap√≥s remove:", selectedFiles.map(f => f ? f.name : null));
        console.log('Contagem atual (n√£o-null):', currentFileCount);
    }

    fileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
            addFiles(event.target.files);
            fileInput.value = '';
        }
    });

    function getFilesToUpload() {
        return selectedFiles.filter(file => file !== null);
    }
</script>

</html>
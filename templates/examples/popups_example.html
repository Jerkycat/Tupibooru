<link rel="stylesheet" href="../../static/css/midnight.css">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />


<dialog class="popup-delete">
    <form action="">
        <div class="popup-title">Excluir Post</div>
        <div class="popup-context">Deseja mesmo excluir este post?<br>Esta a√ß√£o √© irrevers√≠vel.</div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">Excluir</button>
        </div>
    </form>
</dialog>
<dialog class="popup-block">
    <form action="">
        <div class="popup-title">Bloquear Usu√°rio</div>
        <div class="popup-context">Deseja bloquear este usu√°rio?<br>Voc√™ n√£o ver√° mais posts dele(a).</div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">Bloquear</button>
        </div>
    </form>
</dialog>
<dialog class="popup-report">
    <form action="">
        <div class="popup-title">Denunciar Post</div>
        <div class="popup-context">
            <textarea name="Report" placeholder="Motivo da den√∫ncia . . ." rows="5" maxlength="255"></textarea>
        </div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">Denunciar</button>
        </div>
    </form>
</dialog>
<dialog class="popup-moderate">
    <div>
        <div class="popup-title">Moderar Post</div>
        <div class="popup-context">
            <article>
                <section class="post-content">
                    <section class="post-media">
                        <div class="media-wrapper">
                            <img loading="lazy" src="../../static/imgs/decoration/expost1.png" alt="">
                        </div>
                    </section>
                    <section class="post-text">
                        <pre>Este √© um post de exemplo.Possui um √∫nico anexo.</pre>
                    </section>
                </section>
            </article>
        </div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="lock" onclick="openModal()">Trancar</button>
            <button class="pin" onclick="openModal()">Fixar</button>
            <button class="warn" onclick="openModal()">Advertir</button>
            <button class="ban" onclick="openModal()">Banir</button>
        </div>
    </div>
</dialog>
<dialog class="popup-lock">
    <form action="">
        <div class="popup-title">Trancar Post</div>
        <div class="popup-context">Deseja trancar este post?<br>Outros usu√°rios n√£o poder√£o mais respond√™-lo.</div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">Trancar</button>
        </div>
    </form>
</dialog>
<dialog class="popup-pin">
    <form action="">
        <div class="popup-title">Fixar Post</div>
        <div class="popup-context">Deseja fixar este post a p√°gina inicial?</div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">Fixar</button>
        </div>
    </form>
</dialog>
<dialog class="popup-warn">
    <form action="">
        <div class="popup-title">Advertir Post</div>
        <div class="popup-context">
            <textarea name="Warn" placeholder="Motivo da advert√™ncia . . ." rows="3" maxlength="255"></textarea>
        </div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">Advertir</button>
        </div>
    </form>
</dialog>
<dialog class="popup-ban">
    <form action="">
        <div class="popup-title">Banir Usu√°rio</div>
        <div class="popup-context">Deseja banir este usu√°rio? Selecione uma dura√ß√£o.
            <div class="delban">
                <input type="checkbox" id="delban">
                <label for="delban">Excluir o hist√≥rico de posts deste usu√°rio</label>
            </div>
        </div>
        <div class="popup-buttons">
            <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="submit">1d</button>
            <button class="submit">3d</button>
            <button class="submit">7d</button>
            <button class="submit">1m</button>
            <button class="submit">3m</button>
            <button class="submit">Perma</button>
        </div>
    </form>
</dialog>
<dialog class="popup-post">
    <form action="">
        <div class="popup-title">Criar Post</div>
        <div class="popup-context">
            <textarea name="Title" placeholder="T√≠tulo (Opcional)" rows="1" maxlength="255"></textarea>
        </div>
        <div class="popup-context">
            <textarea name="Text" placeholder="Inserir mensagem . . ." rows="5" maxlength="255"></textarea>
        </div>
        <div class="popup-context">
            <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
                style="display: none;">
            <button type="button" class="select-file-button"
                onclick="document.getElementById('fileInput').click()">Selecione um arquivo</button>
            <div class="file-previews-container">
            </div>
            <div class="popup-buttons">
                <button class="cancel" type="button" onclick="closeModal(this.closest('dialog'))">Cancelar</button>
                <button class="create">Publicar</button>
            </div>
    </form>
</dialog>

<dialog class="popup-avatar">
    <form action="" enctype="multipart/form-data">
        <div class="popup-title">Avatar</div>
        <div class="popup-content">
            <div class="avatar-preview">
                <img id="avatar-preview-img" src="../../static/imgs/decoration/anon.png" alt="Preview do avatar">
            </div>
            <div class="upload-section">
                <div class="popup-context">Enviar um novo avatar:</div>
                <input type="file" id="avatar-upload" name="avatar" accept="image/*" style="display: none;">
                <label for="avatar-upload" class="upload-button">Selecionar arquivo</label>
                <div class="file-name" id="file-name">Nenhum arquivo selecionado</div>
            </div>
        </div>
        <div class="popup-buttons">
            <button class="underline-button cancel" type="button"
                onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="default-button submit">Confirmar</button>
        </div>
    </form>
</dialog>

<dialog class="popup-manage">
    <form action="">
        <div class="popup-manage-container">
            <!-- Lista de op√ß√µes √† esquerda -->
            <div class="popup-manage-sidebar">
                <ul class="popup-manage-options">
                    <li class="popup-manage-option active" data-option="boards">Boards</li>
                    <li class="popup-manage-option" data-option="outra-opcao">Outra Op√ß√£o</li>
                </ul>
            </div>

            <!-- Conte√∫do √† direita -->
            <div class="popup-manage-content">
                <!-- Conte√∫do da op√ß√£o Boards -->
                <div class="popup-manage-tab active" data-tab="boards">
                    <div class="boards-list">
                        <!-- Section 1 -->
                        <section class="board-section">
                            <div class="side-title">
                                <span>/bo/ - Boteco</span>
                                <button type="button" class="default-button minimize">
                                    <span class="material-symbols-outlined">expand_less</span>
                                </button>
                            </div>
                            <div class="side-content collapsed">
                                <div class="moderator-list">
                                    <div class="moderator-item">
                                        <span>Usu√°rio 1</span>
                                        <button type="button" class="remove-moderator">X</button>
                                    </div>
                                    <div class="moderator-item">
                                        <span>Usu√°rio 2</span>
                                        <button type="button" class="remove-moderator">X</button>
                                    </div>
                                </div>
                                <input type="text" class="add-moderator-input" placeholder="Nome de Usu√°rio">
                                <button type="button" class="default-button add-moderator">Adicionar como
                                    moderador</button>
                            </div>
                        </section>

                        <!-- Sections 2-6 (similares) -->
                        <section class="board-section">
                            <div class="side-title">
                                <span>/an/ - Animang√°</span>
                                <button type="button" class="default-button minimize">
                                    <span class="material-symbols-outlined">expand_less</span>
                                </button>
                            </div>
                            <div class="side-content collapsed">
                                <div class="moderator-list"></div>
                                <input type="text" class="add-moderator-input" placeholder="Nome de Usu√°rio">
                                <button type="button" class="default-button add-moderator">Adicionar como
                                    moderador</button>
                            </div>
                        </section>

                        <section class="board-section">
                            <div class="side-title">
                                <span>/tv/ - Filmes e S√©ries</span>
                                <button type="button" class="default-button minimize">
                                    <span class="material-symbols-outlined">expand_less</span>
                                </button>
                            </div>
                            <div class="side-content collapsed">
                                <div class="moderator-list"></div>
                                <input type="text" class="add-moderator-input" placeholder="Nome de Usu√°rio">
                                <button type="button" class="default-button add-moderator">Adicionar como
                                    moderador</button>
                            </div>
                        </section>

                        <section class="board-section">
                            <div class="side-title">
                                <span>/cri/ - Cria√ß√µes</span>
                                <button type="button" class="default-button minimize">
                                    <span class="material-symbols-outlined">expand_less</span>
                                </button>
                            </div>
                            <div class="side-content collapsed">
                                <div class="moderator-list"></div>
                                <input type="text" class="add-moderator-input" placeholder="Nome de Usu√°rio">
                                <button type="button" class="default-button add-moderator">Adicionar como
                                    moderador</button>
                            </div>
                        </section>

                        <section class="board-section">
                            <div class="side-title">
                                <span>/pc/ - Computarias</span>
                                <button type="button" class="default-button minimize">
                                    <span class="material-symbols-outlined">expand_less</span>
                                </button>
                            </div>
                            <div class="side-content collapsed">
                                <div class="moderator-list"></div>
                                <input type="text" class="add-moderator-input" placeholder="Nome de Usu√°rio">
                                <button type="button" class="default-button add-moderator">Adicionar como
                                    moderador</button>
                            </div>
                        </section>

                        <section class="board-section">
                            <div class="side-title">
                                <span>/flb/ - Faria Lima Bets</span>
                                <button type="button" class="default-button minimize">
                                    <span class="material-symbols-outlined">expand_less</span>
                                </button>
                            </div>
                            <div class="side-content collapsed">
                                <div class="moderator-list"></div>
                                <input type="text" class="add-moderator-input" placeholder="Nome de Usu√°rio">
                                <button type="button" class="default-button add-moderator">Adicionar como
                                    moderador</button>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Conte√∫do da outra op√ß√£o -->
                <div class="popup-manage-tab" data-tab="outra-opcao">
                    Conte√∫do da outra op√ß√£o aqui
                </div>
            </div>
        </div>

        <div class="popup-buttons">
            <button class="underline-button cancel" type="button"
                onclick="closeModal(this.closest('dialog'))">Cancelar</button>
            <button class="default-button submit">Salvar mudan√ßas</button>
        </div>
    </form>
</dialog>

<script>
    const fileInput = document.getElementById('fileInput');
    const filePreviewsContainer = document.querySelector('.file-previews-container');
    let selectedFiles = []; // Array para armazenar os arquivos selecionados

    // Fun√ß√£o para criar um elemento de preview
    function createFilePreviewElement(file, index) {
        const previewItem = document.createElement('div');
        previewItem.classList.add('file-preview-item');
        // Usamos o data-index para referenciar o item no array selectedFiles,
        // mesmo que o array tenha nulls, o √≠ndice criado aqui permanece associado
        previewItem.dataset.originalIndex = index;

        const thumbnailDiv = document.createElement('div');
        thumbnailDiv.classList.add('file-preview-thumbnail');

        // Adiciona um indicador visual enquanto carrega, se desejar
        // const loadingSpan = document.createElement('span');
        // loadingSpan.textContent = 'Loading...'; // Ou um spinner
        // thumbnailDiv.appendChild(loadingSpan);


        const fileNameSpan = document.createElement('span');
        fileNameSpan.classList.add('file-preview-name');
        fileNameSpan.textContent = file.name;

        const removeButton = document.createElement('button');
        removeButton.classList.add('remove-file-button');
        const closeIconSpan = document.createElement('span');
        closeIconSpan.classList.add('material-symbols-outlined');
        closeIconSpan.textContent = 'close';
        removeButton.appendChild(closeIconSpan);
        removeButton.type = 'button';

        // O bot√£o de remover agora usa o √≠ndice original armazenado no data-set
        removeButton.onclick = () => {
            const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
            removeFilePreview(itemIndex);
        };

        previewItem.appendChild(thumbnailDiv);
        previewItem.appendChild(fileNameSpan);
        previewItem.appendChild(removeButton);

        // ** L√≥gica para criar preview e tratar erros **
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            const reader = new FileReader();

            reader.onload = (e) => {
                // Remove o indicador de loading se usou um
                // if(loadingSpan.parentNode) loadingSpan.parentNode.removeChild(loadingSpan);
                img.src = e.target.result;
                // Adiciona a imagem APENAS ap√≥s o carregamento bem-sucedido
                thumbnailDiv.appendChild(img);
            };

            // ** TRATAMENTO DE ERRO PARA IMAGEM **
            reader.onerror = (e) => {
                console.error('Erro ao ler arquivo de imagem:', file.name, e);
                // Remove o item da lista e do DOM se houver erro
                const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
                removeFilePreview(itemIndex);
                // Opcional: exibir uma mensagem de erro no local do preview
                // thumbnailDiv.textContent = 'Erro';
            };

            reader.readAsDataURL(file);

        } else if (file.type.startsWith('video/')) {
            const video = document.createElement('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let videoObjectURL = null; // Vari√°vel para armazenar o URL do objeto

            video.autoplay = false;
            video.muted = true;
            video.playsInline = true;

            // Quando o metadata do v√≠deo carregar
            video.addEventListener('loadeddata', () => {
                const thumbnailSize = 40;
                canvas.width = thumbnailSize;
                canvas.height = thumbnailSize;

                video.currentTime = 0.1;
            });

            // Quando o v√≠deo buscar o tempo especificado
            video.addEventListener('seeked', () => {
                try {
                    // Remove o indicador de loading se usou um
                    // if(loadingSpan.parentNode) loadingSpan.parentNode.removeChild(loadingSpan);

                    const videoRatio = video.videoWidth / video.videoHeight;
                    const thumbnailRatio = canvas.width / canvas.height;
                    let sx, sy, sWidth, sHeight;

                    if (videoRatio > thumbnailRatio) {
                        sHeight = video.videoHeight;
                        sWidth = sHeight * thumbnailRatio;
                        sx = (video.videoWidth - sWidth) / 2;
                        sy = 0;
                    } else {
                        sWidth = video.videoWidth;
                        sHeight = sWidth / thumbnailRatio;
                        sx = 0;
                        sy = (video.videoHeight - sHeight) / 2;
                    }

                    context.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

                    const img = document.createElement('img');
                    img.src = canvas.toDataURL('image/jpeg');

                    // Adiciona a imagem APENAS ap√≥s a gera√ß√£o bem-sucedida
                    thumbnailDiv.appendChild(img);

                    // Libera o Object URL ap√≥s o uso bem-sucedido
                    if (videoObjectURL) URL.revokeObjectURL(videoObjectURL);

                } catch (e) {
                    console.error('Erro ao gerar thumbnail do v√≠deo:', file.name, e);
                    // Remove o item se houver erro na gera√ß√£o da thumbnail
                    const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
                    removeFilePreview(itemIndex);
                    // Opcional: exibir uma mensagem de erro
                    // thumbnailDiv.textContent = 'Erro Thumbnail';
                    // Libera o Object URL mesmo com erro
                    if (videoObjectURL) URL.revokeObjectURL(videoObjectURL);
                }

            }, { once: true });

            // ** TRATAMENTO DE ERRO PARA V√çDEO (carregamento) **
            video.addEventListener('error', (e) => {
                console.error('Erro ao carregar v√≠deo para thumbnail:', file.name, e);
                // Remove o item da lista e do DOM se houver erro de carregamento
                const itemIndex = parseInt(previewItem.dataset.originalIndex, 10);
                removeFilePreview(itemIndex);
                // Opcional: exibir um √≠cone de erro ou mensagem
                const errorIcon = document.createElement('span');
                errorIcon.textContent = '‚ùå'; // Ou outro √≠cone de erro
                errorIcon.style.fontSize = '1.5rem';
                thumbnailDiv.appendChild(errorIcon);

                // Libera o Object URL mesmo com erro
                if (videoObjectURL) URL.revokeObjectURL(videoObjectURL);
            });

            // Carrega o v√≠deo (este URL precisa ser liberado depois)
            videoObjectURL = URL.createObjectURL(file);
            video.src = videoObjectURL;

        } else {
            // √çcone ou texto para outros tipos de arquivo (n√£o ass√≠ncrono, menos propenso a erro)
            // Remove o indicador de loading se usou um
            // if(loadingSpan.parentNode) loadingSpan.parentNode.removeChild(loadingSpan);
            const fileIcon = document.createElement('span');
            fileIcon.textContent = 'üìÑ';
            fileIcon.style.fontSize = '1.5rem';
            thumbnailDiv.appendChild(fileIcon);
        }

        // Retorna o elemento do preview. O conte√∫do da thumbnail (imagem/v√≠deo)
        // ser√° adicionado √† thumbnailDiv de forma ass√≠ncrona depois.
        return previewItem;
    }

    // A fun√ß√£o removeFilePreview j√° lida com a remo√ß√£o do item e
    // a atualiza√ß√£o do estado do bot√£o com base no array selectedFiles.
    // Apenas ajustamos para usar o data-index no onclick do bot√£o.
    function removeFilePreview(index) {
        console.log('Removendo arquivo no √≠ndice:', index);
        // Remove o elemento do DOM usando o data-original-index
        const itemToRemove = filePreviewsContainer.querySelector(`.file-preview-item[data-original-index="${index}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }

        // Remove o arquivo do array selectedFiles definindo como null
        if (index >= 0 && index < selectedFiles.length) {
            selectedFiles[index] = null;
        } else {
            console.warn('Tentativa de remover √≠ndice inv√°lido:', index);
        }


        // Reabilita o bot√£o de selecionar arquivo se o limite n√£o for mais atingido
        // Conta apenas os itens que n√£o s√£o null no array
        const currentFileCount = selectedFiles.filter(file => file !== null).length;
        console.log('Contagem atual de arquivos:', currentFileCount);
        if (currentFileCount < 3) {
            document.querySelector('.select-file-button').disabled = false;
        }

        // Opcional: Limpar o array de nulos periodicamente ou antes de enviar
        // selectedFiles = selectedFiles.filter(file => file !== null);
        // ATEN√á√ÉO: Se fizer isso, precisaria reindexar os data-original-index
        // de TODOS os elementos restantes no DOM para que removeFilePreview
        // continue funcionando corretamente. Manter os nulls e filtrar no final
        // (em getFilesToUpload) √© mais simples para esta UI.
    }


    // A fun√ß√£o addFiles permanece praticamente a mesma, apenas certificando-se
    // de que o √≠ndice passado para createFilePreviewElement √© o correto
    // (o √≠ndice no array selectedFiles no momento da adi√ß√£o).
    function addFiles(files) {
        const selectButton = document.querySelector('.select-file-button');
        // Contagem atual de arquivos N√ÉO NULOS
        const currentFileCount = selectedFiles.filter(file => file !== null).length;
        const filesToAdd = Array.from(files).slice(0, 3 - currentFileCount);

        if (filesToAdd.length === 0) {
            // Se j√° atingiu o limite e tentou adicionar mais, garante que o bot√£o continue desabilitado
            if (currentFileCount >= 3) {
                selectButton.disabled = true;
            }
            return; // N√£o h√° arquivos para adicionar ou espa√ßo
        }

        filesToAdd.forEach(file => {
            // Encontra o pr√≥ximo √≠ndice dispon√≠vel (primeiro null ou o final do array)
            let nextIndex = selectedFiles.indexOf(null);
            if (nextIndex === -1) {
                nextIndex = selectedFiles.length;
                selectedFiles.push(file); // Adiciona no final
            } else {
                selectedFiles[nextIndex] = file; // Preenche o slot null
            }

            const previewElement = createFilePreviewElement(file, nextIndex);

            // --- AQUI EST√Å A MUDAN√áA: Usar setTimeout ---
            setTimeout(() => {
                filePreviewsContainer.appendChild(previewElement);
                // Ap√≥s adicionar, verifica novamente se o limite foi atingido e desabilita o bot√£o
                // Baseado na contagem de arquivos n√£o-null
                const updatedFileCount = selectedFiles.filter(f => f !== null).length;
                if (updatedFileCount >= 3) {
                    selectButton.disabled = true;
                }

                // Opcional: For√ßar um reflow (√†s vezes ajuda em casos mais teimosos, mas pode impactar performance)
                // void previewElement.offsetHeight;

            }, 0); // Atraso de 0ms significa executar na pr√≥xima oportunidade do loop de eventos

        });

        // Remove a l√≥gica de desabilitar o bot√£o que estava aqui antes,
        // pois ela foi movida para dentro do setTimeout callback.

        console.log("Scheduled addition for:", filesToAdd.map(f => f ? f.name : null));
        console.log("selectedFiles total (n√£o-null) ap√≥s agendar adi√ß√£o:", selectedFiles.filter(f => f !== null).length);
    }

    // A fun√ß√£o removeFilePreview permanece a mesma
    function removeFilePreview(index) {
        console.log('Removendo arquivo no √≠ndice:', index);
        const itemToRemove = filePreviewsContainer.querySelector(`.file-preview-item[data-original-index="${index}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }

        if (index >= 0 && index < selectedFiles.length) {
            selectedFiles[index] = null; // Set to null
        } else {
            console.warn('Tentativa de remover √≠ndice inv√°lido:', index);
        }

        // Re-enable button if non-null count drops below 3
        const selectButton = document.querySelector('.select-file-button');
        const currentFileCount = selectedFiles.filter(file => file !== null).length;
        if (currentFileCount < 3) {
            selectButton.disabled = false;
        }

        console.log("selectedFiles ap√≥s remove:", selectedFiles.map(f => f ? f.name : null));
        console.log('Contagem atual (n√£o-null):', currentFileCount);
    }


    // Event listener para a mudan√ßa no input de arquivo (permanece o mesmo)
    fileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
            addFiles(event.target.files);
            // Limpa o input para que o evento 'change' dispare mesmo se o mesmo arquivo for selecionado novamente ap√≥s remo√ß√£o
            fileInput.value = '';
        }
    });

    // Fun√ß√£o para obter os arquivos para envio (permanece a mesma, filtra nulls)
    function getFilesToUpload() {
        return selectedFiles.filter(file => file !== null);
    }
</script>